<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fullscreen Dynamic Lockscreen</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Google Fonts for Clock and UI */
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto:wght@400;500&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body { font-family: 'Roboto', sans-serif; background-color: #1a1a1a; color: white; }

        #lock-screen {
            position: relative; width: 100vw; height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?auto=format&fit=crop&w=1950');
            background-size: cover; background-position: center center; overflow: hidden;
            transition: background-image 0.5s ease-in-out;
        }
        /* Style for when panning mode is active */
        #lock-screen.panning-active { cursor: grab; }
        #lock-screen.panning-active:active { cursor: grabbing; }

        #status-bar {
            position: absolute; top: 20px; left: 30px; font-size: 1rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6); z-index: 20;
        }

        #weather-info {
            display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none;
            padding: 10px 15px; border-radius: 12px; transition: background-color 0.2s;
            background-color: rgba(0, 0, 0, 0.2);
        }
        #weather-info:hover { background-color: rgba(255,255,255,0.1); }

        .draggable-item { position: absolute; user-select: none; cursor: grab; z-index: 10; }
        .draggable-item:active { cursor: grabbing; z-index: 11; }

        #clock {
            top: 30%; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-family: 'Oswald', sans-serif;
            font-weight: 700; color: #fff; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5));
        }
        #clock:active { filter: drop-shadow(0 0 25px rgba(0,0,0,0.7)); }

        #hours, #minutes { font-size: clamp(6rem, 15vw, 12rem); line-height: 0.8; pointer-events: none; }
        #minutes { margin-top: -1.5rem; }

        .app-icon { width: 70px; height: 70px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)); transition: transform 0.2s ease; }
        .app-icon:active { transform: scale(1.1); }
        .app-icon svg { width: 100%; height: 100%; }

        #youtube-music-btn { top: 60%; left: calc(50% - 100px); }
        #youtube-btn { top: 60%; left: calc(50% + 30px); }

        #wallpaper-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        #wallpaper-menu.visible { display: flex; opacity: 1; }
        .menu-content { background-color: #2c2c2e; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; color: #f2f2f7; text-align: center; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 0.3s ease; }
        #wallpaper-menu.visible .menu-content { transform: scale(1); }
        #close-menu-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #aaa; font-size: 2rem; cursor: pointer; line-height: 1; }
        .menu-content h2 { margin-bottom: 10px; }
        .menu-content p { margin-bottom: 20px; color: #aaa; }
        #wallpaper-url-input { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 10px; border: 1px solid #555; background-color: #3a3a3c; color: white; font-size: 1rem; outline: none; }
        #wallpaper-url-input:focus { border-color: #0a84ff; box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3); }
        #wallpaper-choices { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background-color: #1c1c1e; border-radius: 10px; }
        
        .wallpaper-thumbnail { position: relative; width: 100%; padding-bottom: 100%; background-size: cover; background-position: center; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s, transform 0.2s; }
        .wallpaper-thumbnail:hover { border-color: #0a84ff; transform: scale(1.05); }

        .remove-thumb-btn { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; line-height: 20px; font-family: sans-serif; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .wallpaper-thumbnail:hover .remove-thumb-btn { opacity: 1; }
    </style>
</head>
<body>
    <div id="lock-screen">
        <div id="status-bar">
            <div id="weather-info" title="Double-click to change wallpaper">
                <span id="date"></span> <i id="weather-icon" class="fa-solid fa-cloud-sun"></i> <span id="temperature">...</span>
            </div>
        </div>

        <div id="clock" class="draggable-item" title="Drag to move, double-click for fullscreen">
            <div id="hours">00</div> <div id="minutes">00</div>
        </div>
        
        <div id="youtube-music-btn" class="draggable-item app-icon">
            <a href="https://music.youtube.com/" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#FF0000"/><circle cx="50" cy="50" r="23" fill="none" stroke="white" stroke-width="4"/><polygon points="43,38 62,50 43,62" fill="white"/></svg></a>
        </div>
        
        <div id="youtube-btn" class="draggable-item app-icon">
            <a href="https://www.youtube.com/" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#FF0000"/><path d="M 35,29 A 10,10 0 0 0 25,39 V 61 A 10,10 0 0 0 35,71 H 65 A 10,10 0 0 0 75,61 V 39 A 10,10 0 0 0 65,29 Z" fill="white"/><polygon points="45,42 62,50 45,58" fill="#FF0000"/></svg></a>
        </div>
    </div>

    <div id="wallpaper-menu">
        <div class="menu-content">
            <button id="close-menu-btn">×</button> <h2>Change Wallpaper</h2>
            <p>Paste an image URL below and press Enter.</p>
            <input type="text" id="wallpaper-url-input" placeholder="https://example.com/image.jpg">
            <h3>Your Wallpapers</h3> <div id="wallpaper-choices"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lockScreen = document.getElementById('lock-screen'); 
            const clock = document.getElementById('clock');
            const DRAGGABLE_ELEMENT_IDS = ['clock', 'youtube-music-btn', 'youtube-btn'];
            const initialWallpaper = { url: 'https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?auto=format&fit=crop&w=1950', position: 'center center' };

            // -- Time and Date --
            function updateTime() {
                const now = new Date();
                document.getElementById('hours').textContent = String(now.getHours()).padStart(2, '0');
                document.getElementById('minutes').textContent = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('date').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }
            setInterval(updateTime, 1000); updateTime();
            
            // -- Draggable Icons --
            function savePositions() {
                const positions = {};
                DRAGGABLE_ELEMENT_IDS.forEach(id => {
                    const el = document.getElementById(id); if (el) positions[id] = { top: el.style.top, left: el.style.left };
                });
                localStorage.setItem('lockscreenItemPositions', JSON.stringify(positions));
            }
            function loadPositions() {
                const savedPositions = JSON.parse(localStorage.getItem('lockscreenItemPositions'));
                if (savedPositions) {
                    Object.keys(savedPositions).forEach(id => {
                        const el = document.getElementById(id); const pos = savedPositions[id];
                        if (el && pos.top && pos.left) { el.style.top = pos.top; el.style.left = pos.left; el.style.transform = 'none'; }
                    });
                }
            }
            function makeDraggable(element) {
                let offsetX, offsetY, isDragging, hasMoved;
                const move = (e) => {
                    if (!isDragging) return; e.preventDefault(); hasMoved = true;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    let newX = clientX - offsetX; let newY = clientY - offsetY;
                    const screenRect = lockScreen.getBoundingClientRect(); const elRect = element.getBoundingClientRect();
                    newX = Math.max(0, Math.min(newX, screenRect.width - elRect.width));
                    newY = Math.max(0, Math.min(newY, screenRect.height - elRect.height));
                    element.style.left = `${newX}px`; element.style.top = `${newY}px`; element.style.transform = 'none';
                };
                const startDrag = (e) => {
                    isDragging = true; hasMoved = false;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    offsetX = clientX - element.offsetLeft; offsetY = clientY - element.offsetTop;
                    document.addEventListener('mousemove', move); document.addEventListener('touchmove', move, { passive: false });
                    document.addEventListener('mouseup', stopDrag); document.addEventListener('touchend', stopDrag);
                };
                const stopDrag = () => { if (!isDragging) return; isDragging = false; savePositions(); document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); document.removeEventListener('mouseup', stopDrag); document.removeEventListener('touchend', stopDrag); };
                element.addEventListener('mousedown', startDrag); element.addEventListener('touchstart', startDrag);
                const link = element.querySelector('a');
                if (link) { link.addEventListener('click', (e) => { if (hasMoved) e.preventDefault(); }); }
            }
            DRAGGABLE_ELEMENT_IDS.forEach(id => { const el = document.getElementById(id); if (el) makeDraggable(el); });
            clock.addEventListener('dblclick', () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });

            // -- Weather (No API Key) --
            function fetchWeather() {
                const url = 'https://wttr.in/Trondheim?format=j1';
                const iconMap = { 'sunny': 'fa-sun', 'clear': 'fa-sun', 'partly cloudy': 'fa-cloud-sun', 'cloudy': 'fa-cloud', 'overcast': 'fa-cloud', 'mist': 'fa-smog', 'fog': 'fa-smog', 'patchy rain': 'fa-cloud-rain', 'rain': 'fa-cloud-showers-heavy', 'drizzle': 'fa-cloud-rain', 'patchy snow': 'fa-snowflake', 'snow': 'fa-snowflake', 'sleet': 'fa-cloud-meatball', 'ice pellets': 'fa-icicles', 'thunder': 'fa-cloud-bolt', 'blizzard': 'fa-wind' };
                fetch(url).then(r => r.json()).then(data => {
                    const cond = data.current_condition[0];
                    document.getElementById('temperature').textContent = `${cond.temp_C}°C`;
                    const desc = cond.weatherDesc[0].value.toLowerCase();
                    let icon = 'fa-cloud-sun';
                    for (const key in iconMap) { if (desc.includes(key)) { icon = iconMap[key]; break; } }
                    document.getElementById('weather-icon').className = `fa-solid ${icon}`;
                }).catch(e => { console.error('Weather error:', e); document.getElementById('temperature').textContent = 'N/A'; });
            }

            // -- Wallpaper System (Now with Panning!) --
            const wallpaperMenu = document.getElementById('wallpaper-menu');
            const urlInput = document.getElementById('wallpaper-url-input');
            let isPanningMode = false, currentWallpaperImg = new Image();

            const getWallpapers = () => JSON.parse(localStorage.getItem('lockscreenWallpapers_v2')) || [initialWallpaper];
            const saveWallpapers = (wallpapers) => localStorage.setItem('lockscreenWallpapers_v2', JSON.stringify(wallpapers));
            
            function setWallpaper(wallpaperObject) {
                exitPanningMode();
                lockScreen.style.backgroundImage = `url('${wallpaperObject.url}')`;
                lockScreen.style.backgroundPosition = wallpaperObject.position || 'center center';
                currentWallpaperImg.src = wallpaperObject.url;
            }

            function renderWallpaperChoices() {
                const choicesContainer = document.getElementById('wallpaper-choices');
                choicesContainer.innerHTML = '';
                getWallpapers().forEach(wp => {
                    const thumb = document.createElement('div'); thumb.className = 'wallpaper-thumbnail';
                    thumb.style.backgroundImage = `url('${wp.url}')`;
                    
                    const removeBtn = document.createElement('span'); removeBtn.className = 'remove-thumb-btn';
                    removeBtn.innerHTML = '×'; removeBtn.title = 'Remove wallpaper';
                    
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const newWallpapers = getWallpapers().filter(w => w.url !== wp.url);
                        saveWallpapers(newWallpapers);
                        renderWallpaperChoices();
                    });
                    thumb.appendChild(removeBtn);
                    
                    thumb.addEventListener('click', () => { setWallpaper(wp); wallpaperMenu.classList.remove('visible'); });
                    choicesContainer.appendChild(thumb);
                });
            }

            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const url = urlInput.value.trim();
                    if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
                        const wallpapers = getWallpapers();
                        if (!wallpapers.some(wp => wp.url === url)) {
                            const newWallpaper = { url: url, position: 'center center' };
                            wallpapers.push(newWallpaper);
                            saveWallpapers(wallpapers);
                            setWallpaper(newWallpaper);
                            renderWallpaperChoices();
                        }
                        urlInput.value = '';
                    } else { alert('Please enter a valid direct image URL.'); }
                }
            });

            // -- Panning Mode Logic --
            function exitPanningMode() {
                if (!isPanningMode) return;
                isPanningMode = false;
                lockScreen.classList.remove('panning-active');
                
                const currentURL = currentWallpaperImg.src;
                const wallpapers = getWallpapers();
                const wallpaperIndex = wallpapers.findIndex(wp => wp.url === currentURL);
                if (wallpaperIndex > -1) {
                    wallpapers[wallpaperIndex].position = lockScreen.style.backgroundPosition;
                    saveWallpapers(wallpapers);
                }
            }

            lockScreen.addEventListener('dblclick', (e) => {
                if (e.target !== lockScreen) return; // Only trigger on the background itself
                if (isPanningMode) {
                    exitPanningMode();
                } else {
                    const screenW = lockScreen.clientWidth; const screenH = lockScreen.clientHeight;
                    const imgW = currentWallpaperImg.naturalWidth; const imgH = currentWallpaperImg.naturalHeight;
                    // Enter panning mode only if image is larger than screen in at least one dimension
                    if (imgW > screenW || imgH > screenH) {
                        isPanningMode = true;
                        lockScreen.classList.add('panning-active');
                    }
                }
            });

            let isDraggingWallpaper = false, startPanX, startPanY, startBgX, startBgY;
            lockScreen.addEventListener('mousedown', (e) => {
                if (!isPanningMode || e.target !== lockScreen) return;
                isDraggingWallpaper = true;
                const computedStyle = window.getComputedStyle(lockScreen);
                const bgPos = computedStyle.backgroundPosition.split(' ');
                startBgX = parseFloat(bgPos[0]); startBgY = parseFloat(bgPos[1]);
                startPanX = e.clientX; startPanY = e.clientY;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDraggingWallpaper) return;
                const deltaX = e.clientX - startPanX; const deltaY = e.clientY - startPanY;
                let newBgX = startBgX + deltaX; let newBgY = startBgY + deltaY;

                const screenW = lockScreen.clientWidth; const screenH = lockScreen.clientHeight;
                const imgW = currentWallpaperImg.naturalWidth; const imgH = currentWallpaperImg.naturalHeight;
                
                // Calculate the scaled image dimensions to respect 'background-size: cover'
                const screenRatio = screenW / screenH; const imgRatio = imgW / imgH;
                let scaledW, scaledH;
                if (imgRatio > screenRatio) { // Image is wider
                    scaledH = screenH; scaledW = screenH * imgRatio;
                } else { // Image is taller or same ratio
                    scaledW = screenW; scaledH = screenW / imgRatio;
                }

                // Clamp position to keep image in view
                const minX = screenW - scaledW; const minY = screenH - scaledH;
                newBgX = Math.max(minX, Math.min(0, newBgX));
                newBgY = Math.max(minY, Math.min(0, newBgY));
                
                lockScreen.style.backgroundPosition = `${newBgX}px ${newBgY}px`;
            });

            document.addEventListener('mouseup', () => { isDraggingWallpaper = false; });
            
            // -- Menu Controls --
            const weatherInfo = document.getElementById('weather-info');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            weatherInfo.addEventListener('dblclick', () => wallpaperMenu.classList.add('visible'));
            closeMenuBtn.addEventListener('click', () => wallpaperMenu.classList.remove('visible'));
            wallpaperMenu.addEventListener('click', (e) => { if (e.target === wallpaperMenu) wallpaperMenu.classList.remove('visible'); });

            // -- Initial Load --
            loadPositions();
            fetchWeather();
            setInterval(fetchWeather, 30 * 60 * 1000);
            renderWallpaperChoices();
            const lastWallpaper = getWallpapers().slice(-1)[0] || initialWallpaper;
            setWallpaper(lastWallpaper);
        });
    </script>
</body>
</html>
